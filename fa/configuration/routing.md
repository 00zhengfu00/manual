---
refcn: chapter_02/03_routing
refen: configuration/routing
---
# مسیریابی

V2Ray دارای مکانیزم مسیریابی داخلی است. این ارتباطات ورودی به خروجی های مختلف را براساس قوانین انجام می دهد. یک سناریو معمول این است که تقسیم ترافیک به وسیله کشور انجام شود. V2Ray می تواند کشور مقصد (توسط Geo IP) یک اتصال را شناسایی کند و سپس اتصال به پروکسی خروجی مربوطه را ارسال کند.

## RoutingObject

`RoutingObject` به عنوان `مسیریابی` در پیکربندی سطح بالا استفاده می شود.

```javascript
{
  "domainStrategy": "AsIs"،
  "قوانین": []
}
```

> `domainStrategy`: "AsIs" | "IPIfNonMatch" | "IPOnDemand"

استراتژی قطعنامه دامنه انتخاب ها عبارتند از:

* `"AsIs"`: فقط از دامنه برای مسیریابی استفاده کنید. مقدار پیش فرض.
* `"IPIfNonMatch"`: زمانی که هیچ قاعده ای با دامنه فعلی منطبق نیست، V2Ray آن را به آدرس های IP (A یا AAAA) رفع می کند و دوباره تمام قوانین را امتحان می کند. 
  * اگر یک دامنه دارای چندین آدرس IP باشد، V2Ray تمام آنها را انجام می دهد.
  * IP های حل شده تنها برای تصمیم گیری مسیریابی استفاده می شوند، ترافیک هنوز به آدرس دامنه اصلی ارسال می شود.
* `"IPOnDemand"`: تا زمانی که یک قانون مبتنی بر IP وجود دارد، V2Ray بلافاصله دامنه را به IP حل خواهد کرد.

> `قوانین`: \ [[RuleObject](#ruleobject)\]

آرایه ای از قوانین برای هر اتصال ورودی، V2Ray این قواعد را از بالا به پایین یک به یک می کند. اگر یک قاعا در حال اجرا است، اتصال به `outboundTag` از قانون هدایت می شود.

### RuleObject

```javascript
{
  "type": "field",
  "domain": [
    "baidu.com",
    "qq.com",
    "geosite:cn"
  ],
  "ip": [
    "0.0.0.0/8",
    "10.0.0.0/8",
    "fc00::/7",
    "fe80::/10",
    "geoip:cn"
  ],
  "port": "0-100",
  "network": "tcp",
  "source": [
    "10.0.0.1"
  ],
  "user": [
    "love@v2ray.com"
  ],
  "inboundTag": [
    "tag-vmess"
  ],
  "protocol":["http", "tls", "bittorrent"],
  "outboundTag": "direct"
}
```

{٪ hint style = 'info'٪}

هنگامی که چندین فیلد مشخص می شود، این فیلدها باید همه راضی باشند تا قوانین موثر باشند. اگر شما نیاز به هر دو `دامنه` و `ip` قوانین، به احتمال زیاد شما نیاز به آنها را به قوانین جداگانه.

{% endhint %}

> `نوع`: "فیلد"

تنها مقدار معتبر در حال حاضر `"میدان"`.

> `دامنه`: \ [رشته \]

مجموعه ای از حوزه ها فرمت های موجود عبارتند از:

* متن ساده: اگر این رشته با هر بخش از دامنه هدفمندی منطبق باشد، این قانون به عهده می گیرد. مثال: rule `"sina.com"` مطابقت دامنه `"sina.com"`، `"sina.com.cn"` و `"www.sina.com"`، اما نه `"sina.cn"`.
* عبارت منظم: شروع با `"regexp:"`، بقیه یک عبارت منظم است. هنگامی که Regexp با هدف دامنه مطابقت می کند، این قانون به اجرا در می آید. مثال: rule `"regexp: \\. goo. * \\. com $"` برابر `"www.google.com"` و `"fonts.googleapis.com"`، اما نه `"google.com"`.
* Subdomain (توصیه می شود): شروع با `"domain:"` و بقیه یک دامنه است. هنگامی که دامنه هدفمند دقیقا همان مقدار است یا یک زیر دامنه از مقدار است، این قانون در حال اجرا است. مثال: قانون `"دامنه: v2ray.com"` مسابقه `"www.v2ray.com"`، `"v2ray.com"`، اما نه `"xv2ray.com"`.
* دامنه کامل: شروع با `"full:"` و بقیه یک دامنه است. هنگامی که دامنه هدفمند دقیقا همان ارزش است، این قانون اثر می گذارد. مثال: قانون `"دامنه: v2ray.com"` مطابق با `"v2ray.com"`، اما نه `"www.v2ray.com"`.
* مقدار ویژه `"geosite: cn"`: لیستی از [دامنه مشترک در چین](https://www.v2ray.com/links/chinasites/).
* مقدار ویژه `"geosite: speedtest"` (V2Ray 3.32+): لیستی از سرورهای عمومی speedtest.net.
* دامنه از فایل: مانند `"ext: file: tag"`. مقدار باید با `ext:` (کوچک) شروع شود و با نام فایل و تگ همراه است. فایل در [منابع دایرکتوری](env.md#location-of-v2ray-asset)دارد و دارای همان قالب `geosite.dat`. برچسب باید در فایل موجود باشد.

> `IP`: \ [رشته \]

مجموعه ای از محدوده IP. هنگامی که IP هدفگذاری در یکی از محدوده ها قرار دارد، این قانون به اجرا در می آید. فرمت های موجود:

* IP: مانند `"127.0.0.1"`.
* [CIDR](https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing): مانند `"127.0.0.0/8"`.
* GeoIP: مانند `"geoip: cn"`. با شروع می شود `geoip:` (حروف کوچک) و دو حرف از کد کشور را دنبال می کند. 
  * مقدار ویژه `"geoip: خصوصی"`: برای تمام آدرس های خصوصی مانند `127.0.0.1`.
* IP ها از فایل: مانند `"ext: file: tag"`. مقدار باید با `ext:` (کوچک) شروع شود و با نام فایل و تگ همراه است. فایل در قرار داده شده [دایرکتوری منبع](env.md#location-of-v2ray-asset)، و همان فرمت از `geoip.dat`. برچسب باید در فایل موجود باشد.

{٪ hint style = 'info'٪}

`"ext: geoip.dat: cn"` معادل `"geoip: cn"`.

{% endhint %}

> `پورت`: شماره | رشته

محدوده بندر فرمت ها عبارتند از:

* `"ab"`: هر دو `a` و `b` عدد صحیح مثبت هستند و کمتر از 65536. هنگامی که پورت هدف گیری در [`a`، `b`)، این قانون در حال اجرا است.

* `a`: `a` یک عدد صحیح مثبت است و کمتر از 65536. هنگامی که پورت هدف `و`، این قانون به اجرا در می آید.

> `شبکه`: "tcp" | "udp" | "tcp، udp"

هنگامی که اتصال در شبکه انتخاب شده است، این قانون اثر می گذارد.

> `منبع`: \ [رشته \]

مجموعه ای از محدوده IP. همان فرمت به عنوان `آی فون`. هنگامی که منبع IP از اتصال در محدوده IP است، این قانون به اجرا در می آید.

> `کاربر`: \ [رشته \]

آرایه ای از آدرس ایمیل هنگامی که اتصال ورودی از یک حساب کاربر از آدرس ایمیل استفاده می کند، این قانون به اجرا در می آید. در حال حاضر Shadowsocks و VMess پشتیبانی از کاربر با ایمیل.

> `inboundTag`: \ [رشته \]

آرایه ای از رشته به عنوان برچسب های پروکسی درون گیرنده. هنگامی که اتصال از یکی از پروکسی های ورودی تعیین شده مشخص می شود، این قانون به اجرا در می آید.

> `پروتکل`: \ ["http" | "TLS" | "bittorrent" \]

آرایه ای از رشته به عنوان نوع پروتکل. هنگامی که اتصال از یکی از پروتکل ها استفاده می کند، این قانون به اجرا در می آید. برای شناسایی پروتکل اتصال، باید `گزینه sniffing` را در پروکسی ورودی فعال کنید.

> `outboundTag` رشته

[برچسب خروجی](protocols.md) که اتصال به آن ارسال می شود، اگر این قانون به اجرا درآید.