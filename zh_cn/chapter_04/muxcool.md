# Mux.Cool 协议

Mux.Cool 协议是一个多路复用传输协议，用于在一条已建立的数据流中传输多个各自独立的数据流。

## 版本

当前版本是 1 Beta。

## 依赖

### 底层协议

Mux.Cool 必须运行在一个已建立的可靠数据流之上。

## 通讯过程

一个 Mux.Cool 连接中可传输若干个子连接，每个子连接有一个独立的 ID 和状态。传输过程由帧（Frame）组成，每一帧用于传输一个特定的子连接的数据。

## 传输格式

Mux.Cool 使用对称传输格式，即客户端和服务器发送和接收相同格式的数据。

### 帧格式

| 2 字节     | L 字节 | X 字节 |
|-----------|--------|-------|
| 元数据长度 L| 元数据 | 其它数据|

### 元数据

| 2 字节 | 1 字节 | 1 字节   | 剩余字节 |
|-------|--------|---------|---------|
| ID    | 状态 S  | 选项 Opt | 额外信息 |

其中：
* 状态 S：
  * 0x01：新建子连接
  * 0x02：继续传输子连接
  * 0x03：子连接结束
* 选项 Opt：
  * D(0x01)：有数据

当 S = 0x01 时，额外信息包含以下数据

| 2 字节 | 1 字节    | X 字节 |
|-------|-----------|-------|
| 端口   | 地址类型 T | 地址 A |

其中：
* 地址类型 T：
  * 0x01：IPv4
  * 0x02：域名
  * 0x03：IPv6
* 地址 A：
  * 当 T = 0x01 时，A 为 4 字节 IPv4 地址；
  * 当 T = 0x02 时，A 为 1 字节长度（L） + L 字节域名；
  * 当 T = 0x03 时，A 为 16 字节 IPv6 地址；

### 额外数据

当选项 Opt(D) 开启时，数据格式如下：

| 2 字节 | L 字节  |
|-------|---------|
| 长度 L | 数据    |

这些数据将被发送目标地址。

## 客户端行为

对于每一个 Mux.Cool 连接，客户端需要保存一个子连接状态表，每个子连接必须拥有唯一的 ID。ID 不可复用。

客户端必须按照`新建子连接 -> 传输 -> 结束`的模式发送连接数据。

## 服务器端行为

服务器必须按客户端的指令转发各个子连接。

服务器的响应数据中，子连接的 ID 必须和客户端的子连接 ID 一致，并且不能使用`新建子连接`状态。

## 应用

在 Shadowsocks 和 VMess 协议中，连接建立时必须包含一个指定的地址。为了保持兼容性，Mux.Cool 协议指定地址为“v1.mux.cool”。即当主连接的目标地址与之匹配时，则进行 Mux.Cool 方式的转发，否则按传统方式进行转发。

## 修订历史

2017.04.03 初版